# Функциональные возможности

[Назад](../README.md)

В этом разделе описаны функциональные возможности, в т.ч. входящие
в состав [основных](https://gitlab.prodcontest.ru/2025-final-indiv-tasks/prod-backend-individual-round-2025#%D0%BE%D0%BF%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%BE%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F).

<!-- TOC -->
* [Функциональные возможности](#функциональные-возможности)
  * [Бекэнд](#бекэнд)
    * [Создание/обновление клиентов и рекламодателей](#созданиеобновление-клиентов-и-рекламодателей)
    * [Получение клиентов и рекламодателей](#получение-клиентов-и-рекламодателей)
    * [Управление рекламными кампаниями](#управление-рекламными-кампаниями)
    * [Настройка таргетирования рекламы](#настройка-таргетирования-рекламы)
    * [Показ рекламных объявлений пользователям](#показ-рекламных-объявлений-пользователям)
    * [Отображение статистики по объявлениям и клиентам](#отображение-статистики-по-объявлениям-и-клиентам)
    * [Управление временем на сервере](#управление-временем-на-сервере)
    * [Загрузка изображений в рекламных кампаниях](#загрузка-изображений-в-рекламных-кампаниях)
    * [Модерация текстов рекламных кампаний](#модерация-текстов-рекламных-кампаний)
    * [Интеграция с LLM для генерации рекламных текстов](#интеграция-с-llm-для-генерации-рекламных-текстов)
  * [Телеграм бот](#телеграм-бот)
    * [Вход в меню рекламодателя](#вход-в-меню-рекламодателя)
    * [Создание кампании](#создание-кампании)
    * [Просмотр кампаний](#просмотр-кампаний-)
    * [Редактирование кампании](#редактирование-кампании)
    * [Просмотр статистики](#просмотр-статистики)
  * [Grafana](#grafana)
    * [Advertiser Stats и Campaign Stats](#advertiser-stats-и-campaign-stats)
    * [API Status](#api-status)
<!-- TOC -->

## Бекэнд

(см. [документацию API ->](../README.md#документация-api)).

### Создание/обновление клиентов и рекламодателей

Производится на эндпоинтах `POST /clients/bulk` и
`POST /advertisers/bulk` соответственно.

Примеры входных данных:
```json
// /clients/bulk
[
  {
    "client_id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "login": "string",
    "age": 1,
    "location": "string",
    "gender": "FEMALE"
  }
]
```
```json
// /advertisers/bulk
[
  {
    "advertiser_id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "name": "string123"
  }
]
```

![01](fig/back01.gif)

### Получение клиентов и рекламодателей

Производится на эндпоинтах `GET /clients/{id}` и
`GET /advertisers/{id}` соответственно.

### Управление рекламными кампаниями

Создание рекламной кампании производится на 
`POST /advertisers/{advertiser_id}/campaigns`,
получение их списка на 
`GET /advertisers/{advertiser_id}/campaigns`.

Получение, редактирование и удаление одной кампании
производится на эндпоинтах 
`GET, PUT, DELETE /advertisers/{advertiser_id}/campaigns/{campaign_id}`
соответственно.

Пример входных данных:
```json
// POST /advertisers/3fa85f64-5717-4562-b3fc-2c963f66afa6/campaigns
{
  "ad_title": "Campaign",
  "ad_text": "text",
  "impressions_limit": 120,
  "clicks_limit": 120,
  "cost_per_impression": 10,
  "cost_per_click": 1.5,
  "start_date": 1,
  "end_date": 5,
  "targeting": {
    "gender": null,
    "age_from": null,
    "age_to": null,
    "location": null
  }
}
```
```json
// PUT /advertisers/3fa85f64-5717-4562-b3fc-2c963f66afa6/campaigns/{campaign_id}
{
  "ad_title": "123",
  "ad_text": "123",
  "cost_per_impression": 23,
  "cost_per_click": 43,
  "targeting": {
    "gender": "ALL",
    "age_from": null,
    "age_to": null,
    "location": "Moscow"
  }
}
```

![04](fig/back04.gif)

### Настройка таргетирования рекламы

Эндпоинт для задания "весов"-отношений клиентов и 
рекламодателей - `POST /ml-scores`.

Пример входных данных:
```json
{
  "client_id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "advertiser_id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "score": 1234
}
```

![05](fig/back05.gif)

### Показ рекламных объявлений пользователям

Для запроса рекламы для данного пользователя нужно
воспользоваться эндпоинтом `GET /ads`. Если реклама
будет не найдена, будет возвращено 404.

Чтобы обозначить клик пользователя по рекламе, нужно
вызвать `POST /ads/{ad_id}/click`, а в теле передать
идентификатор пользователя `client_id`. 
Кликнуть может только тот пользователь, который уже 
посмотрел эту рекламу.

Клики и показы считаются только один раз для каждой пары
пользователь-объявление (т.е. они уникальны).

Примеры входных данных:
```
GET /ads?client_id=3fa85f64-5717-4562-b3fc-2c963f66afa6
```
```json
// POST /ads/{ad_id}/click
{
  "client_id": "3fa85f64-5717-4562-b3fc-2c963f66afa6"
}
```
![06](fig/back06.gif)

### Отображение статистики по объявлениям и клиентам

Эндпоинты:
- Получение статистики по ID рекламному объявлению
  `GET /stats/campaigns/{id}`
- Получение статистики по всем рекламным объявлениям рекламодателя.
  `GET /stats/advertiser/{id}/campaigns`
- Получение ежедневной статистики по ID рекламного объявления
  `GET /stats/campaigns/{id}/daily`
- Получение ежедневной статистики по всем рекламным объявлениям рекламодателя
  `GET /stats/advertiser/{id}/campaigns/daily`

Атрибуты статистики:

- Количество показов `impressions_count`
- Количество переходов `clicks_count`
- Конверсия из показа в переход (Количество переходов / Количество показов * 100%) `conversion`
- Сумма денег, потраченная на показы `spent_impressions`
- Сумма денег, потраченная на переходы `spent_clicks`
- Сумма денег, потраченная всего `spent_total`

![07](fig/back07.gif)

### Управление временем на сервере

Для переключения для нужно воспользоваться эндпоинтом
`/time/advance`. В теле запроса передать `current_date` -
новую дату на сервере.

```json
{
  "current_date": 1
}
```

![08](fig/back08.gif)


### Загрузка изображений в рекламных кампаниях

Эндпоинты POST и DELETE `/advertisers/{advertiser_id}/campaigns/{campaign_id}/image`
реализуют возможность управлять изображениями в объявлениях. 

Для загрузки изображения нужно отправить файл через POST (multipart form data, 
то есть обычным образом). После этого, при получении кампании вы будете получать
поле `image_uri`, содержащее в себе путь до изображения на файловом сервере.
Принимаются png-совместимые файлы (в т.ч. jpg).

Файловый сервер развернут на 9000 порте.

Для удаления изображения нужно отправить DELETE запрос. При этом произойдет 
"soft delete", т.е. просто занулится поле `image_uri`.

> Заметка на полях
> 
> Все изображения сжимаются до максимального размера 960*960 с сохранением
> отношения сторон.

![09](fig/back09.gif)

### Модерация текстов рекламных кампаний

[Алгоритм ->](sequences.md#модерация-текстов)

По умолчанию автомодерация отключена. Для ее включения нужно послать запрос
`PUT /profanity/enable`. Для установки списка запрещенных слов нужно 
использовать эндпоинт `PUT /profanity/blacklist` 
(см. [документацию API ->](../README.md#документация-api)).

После включения автомодерации и установки списка запрещенных слов, любая
кампания будет отклонена при создании или изменении (в последнем случае
изменения не применятся), если она будет содержать одно из данных слов.

Отключить модерацию: `PUT /profanity/disable`

Примеры входных данных:
```
PUT /profanity/enable

PUT /profanity/blacklist 
["плохо", "плохое"]

POST /advertisers/3fa85f64-5717-4562-b3fc-2c963f66afa6/campaigns
{
  "ad_title": "Campaign",
  "ad_text": "пл0х0. Надеюсь, меня не задетектят",
  "impressions_limit": 120,
  "clicks_limit": 120,
  "cost_per_impression": 10,
  "cost_per_click": 1.5,
  "start_date": 1,
  "end_date": 5,
  "targeting": {
    "gender": null,
    "age_from": null,
    "age_to": null,
    "location": null
  }
}
```

![10](fig/back10.gif)

### Интеграция с LLM для генерации рекламных текстов

Для предоставления конечному пользователю большего контроля, было решено не
смешивать этот функционал с процессом создания/обновления кампании, а вынести
его в отедльный эндпоинт. В поле `topic` указывается
тема рекламы - словосочетание. В поле `language` - язык
(`EN`|`RU`), в поле `additional` - дополнительный контекст
в свободной форме.

Генерация текста: `POST /ai/generate-text` 
(см. [документацию API ->](../README.md#документация-api)).

Пример входных данных:

```json
{
  "topic": "корм для собак",
  "language": "RU",
  "additional": "Укрась все с помощью эмодзи."
}
```

![11](fig/back11.gif)

## Телеграм бот

### Вход в меню рекламодателя

1. `/start`
2. Клик на `[Manage advertiser]`
3. Отправить UUID рекламодателя

![01](fig/bot01.gif)

### Создание кампании

Из меню рекламодателя:
1. Клик на `[Create campaign]`
2. Отправить заголовок кампании
3. Отправить текст кампани и или сгенерировать его:
   1. Клик на `[Generate with AI]`
   2. **Выбрать язык!**
   3. По желанию, изменить параметры
   4. Клик на `[Generate]`
4. Затем поочередно установите остальные значения кампании
5. Выберите таргетинг:
   1. Пол таргетинга (или пропустить)
   2. Начальный возраст (или пропустить)
   3. Конечныый возраст (или пропустить)
   4. Локация (или пропустить)
6. Подтвердите создание
7. Если возникнут ошибки, вернитесь назад: `[Re-enter values]`

![02](fig/bot02.gif)

### Просмотр кампаний 

В меню рекламодателя нажмите на `[List campaigns]`.
В списке выберите нужную кампанию. В сообщении отобразятся
параметры кампании и ее меню.

![03](fig/bot03.gif)

### Редактирование кампании

В меню кампании нажмите на `[Settings]`. В открывшемся
субменю нажмите на интересующий вас параметр, введите его
и отправьте сообщением.

При изменении картинки отправляйте ее не файлом!

![04](fig/bot04.gif)

### Просмотр статистики

Эта процедура одинакова как для меню рекламодателей, 
так и для меню кампаний.

В нужном меню выберите `[Total stats]` или `[Daily stats]`

В меню Total stats будет текстом отображена сводная 
информация.

В меню Daily stats будет отображен график просмотров и 
кликов не более чем за последние 14 дней.

![05](fig/bot05.gif)

## Grafana

В Grafana представлены 3 дашборда: Advertiser Stats, 
Campaign Stats и API Status

### Advertiser Stats и Campaign Stats

Практически идентичны, но замеряют статистику для разных
сущностей (для всех кампаний рекламодателя и для одной
кампании).

На этих дашбордах отображается конверсия, события (клики/показы),
суммарные затраты, а также изменение по дням кликов, показов, конверсии
и затрат.

![01](fig/grafana01.jpg)

> Заметка на полях
> 
> В дропдауне отображаются только те ID, для которых
> в данный момент есть хоть какая-то информация

### API Status

На этом дашборде отображается состояние API: количество 
запросов, их распределение и time series диаграммы
запросов и кодов ответов.

![02](fig/grafana02.png)
